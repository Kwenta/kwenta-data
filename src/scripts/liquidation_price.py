import os
from web3 import Web3
import pandas as pd
import numpy as np
from dotenv import load_dotenv

load_dotenv()

## constants
INFURA_KEY = os.getenv('INFURA_KEY')

w3 = Web3(Web3.HTTPProvider(f'https://optimism-mainnet.infura.io/v3/{INFURA_KEY}'))

market_data_adddress = '0x58e6227510F83d3F45B339F2f7A05a699fDEE6D4'
market_data_abi = '[{"inputs":[{"internalType":"contract IAddressResolver","name":"_resolverProxy","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"constant":true,"inputs":[],"name":"allMarketSummaries","outputs":[{"components":[{"internalType":"address","name":"market","type":"address"},{"internalType":"bytes32","name":"asset","type":"bytes32"},{"internalType":"bytes32","name":"key","type":"bytes32"},{"internalType":"uint256","name":"maxLeverage","type":"uint256"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"uint256","name":"marketSize","type":"uint256"},{"internalType":"int256","name":"marketSkew","type":"int256"},{"internalType":"uint256","name":"marketDebt","type":"uint256"},{"internalType":"int256","name":"currentFundingRate","type":"int256"},{"internalType":"int256","name":"currentFundingVelocity","type":"int256"},{"components":[{"internalType":"uint256","name":"takerFee","type":"uint256"},{"internalType":"uint256","name":"makerFee","type":"uint256"},{"internalType":"uint256","name":"takerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"takerFeeOffchainDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeOffchainDelayedOrder","type":"uint256"}],"internalType":"struct PerpsV2MarketData.FeeRates","name":"feeRates","type":"tuple"}],"internalType":"struct PerpsV2MarketData.MarketSummary[]","name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"allProxiedMarketSummaries","outputs":[{"components":[{"internalType":"address","name":"market","type":"address"},{"internalType":"bytes32","name":"asset","type":"bytes32"},{"internalType":"bytes32","name":"key","type":"bytes32"},{"internalType":"uint256","name":"maxLeverage","type":"uint256"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"uint256","name":"marketSize","type":"uint256"},{"internalType":"int256","name":"marketSkew","type":"int256"},{"internalType":"uint256","name":"marketDebt","type":"uint256"},{"internalType":"int256","name":"currentFundingRate","type":"int256"},{"internalType":"int256","name":"currentFundingVelocity","type":"int256"},{"components":[{"internalType":"uint256","name":"takerFee","type":"uint256"},{"internalType":"uint256","name":"makerFee","type":"uint256"},{"internalType":"uint256","name":"takerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"takerFeeOffchainDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeOffchainDelayedOrder","type":"uint256"}],"internalType":"struct PerpsV2MarketData.FeeRates","name":"feeRates","type":"tuple"}],"internalType":"struct PerpsV2MarketData.MarketSummary[]","name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"globals","outputs":[{"components":[{"internalType":"uint256","name":"minInitialMargin","type":"uint256"},{"internalType":"uint256","name":"liquidationFeeRatio","type":"uint256"},{"internalType":"uint256","name":"minKeeperFee","type":"uint256"},{"internalType":"uint256","name":"maxKeeperFee","type":"uint256"}],"internalType":"struct PerpsV2MarketData.FuturesGlobals","name":"","type":"tuple"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"contract IPerpsV2MarketViews","name":"market","type":"address"}],"name":"marketDetails","outputs":[{"components":[{"internalType":"address","name":"market","type":"address"},{"internalType":"bytes32","name":"baseAsset","type":"bytes32"},{"internalType":"bytes32","name":"marketKey","type":"bytes32"},{"components":[{"internalType":"uint256","name":"takerFee","type":"uint256"},{"internalType":"uint256","name":"makerFee","type":"uint256"},{"internalType":"uint256","name":"takerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"takerFeeOffchainDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeOffchainDelayedOrder","type":"uint256"}],"internalType":"struct PerpsV2MarketData.FeeRates","name":"feeRates","type":"tuple"},{"components":[{"internalType":"uint256","name":"maxLeverage","type":"uint256"},{"internalType":"uint256","name":"maxMarketValue","type":"uint256"}],"internalType":"struct PerpsV2MarketData.MarketLimits","name":"limits","type":"tuple"},{"components":[{"internalType":"uint256","name":"maxFundingVelocity","type":"uint256"},{"internalType":"uint256","name":"skewScale","type":"uint256"}],"internalType":"struct PerpsV2MarketData.FundingParameters","name":"fundingParameters","type":"tuple"},{"components":[{"internalType":"uint256","name":"marketSize","type":"uint256"},{"components":[{"internalType":"uint256","name":"long","type":"uint256"},{"internalType":"uint256","name":"short","type":"uint256"}],"internalType":"struct PerpsV2MarketData.Sides","name":"sides","type":"tuple"},{"internalType":"uint256","name":"marketDebt","type":"uint256"},{"internalType":"int256","name":"marketSkew","type":"int256"}],"internalType":"struct PerpsV2MarketData.MarketSizeDetails","name":"marketSizeDetails","type":"tuple"},{"components":[{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"bool","name":"invalid","type":"bool"}],"internalType":"struct PerpsV2MarketData.PriceDetails","name":"priceDetails","type":"tuple"}],"internalType":"struct PerpsV2MarketData.MarketData","name":"","type":"tuple"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"marketKey","type":"bytes32"}],"name":"marketDetailsForKey","outputs":[{"components":[{"internalType":"address","name":"market","type":"address"},{"internalType":"bytes32","name":"baseAsset","type":"bytes32"},{"internalType":"bytes32","name":"marketKey","type":"bytes32"},{"components":[{"internalType":"uint256","name":"takerFee","type":"uint256"},{"internalType":"uint256","name":"makerFee","type":"uint256"},{"internalType":"uint256","name":"takerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"takerFeeOffchainDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeOffchainDelayedOrder","type":"uint256"}],"internalType":"struct PerpsV2MarketData.FeeRates","name":"feeRates","type":"tuple"},{"components":[{"internalType":"uint256","name":"maxLeverage","type":"uint256"},{"internalType":"uint256","name":"maxMarketValue","type":"uint256"}],"internalType":"struct PerpsV2MarketData.MarketLimits","name":"limits","type":"tuple"},{"components":[{"internalType":"uint256","name":"maxFundingVelocity","type":"uint256"},{"internalType":"uint256","name":"skewScale","type":"uint256"}],"internalType":"struct PerpsV2MarketData.FundingParameters","name":"fundingParameters","type":"tuple"},{"components":[{"internalType":"uint256","name":"marketSize","type":"uint256"},{"components":[{"internalType":"uint256","name":"long","type":"uint256"},{"internalType":"uint256","name":"short","type":"uint256"}],"internalType":"struct PerpsV2MarketData.Sides","name":"sides","type":"tuple"},{"internalType":"uint256","name":"marketDebt","type":"uint256"},{"internalType":"int256","name":"marketSkew","type":"int256"}],"internalType":"struct PerpsV2MarketData.MarketSizeDetails","name":"marketSizeDetails","type":"tuple"},{"components":[{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"bool","name":"invalid","type":"bool"}],"internalType":"struct PerpsV2MarketData.PriceDetails","name":"priceDetails","type":"tuple"}],"internalType":"struct PerpsV2MarketData.MarketData","name":"","type":"tuple"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"address[]","name":"markets","type":"address[]"}],"name":"marketSummaries","outputs":[{"components":[{"internalType":"address","name":"market","type":"address"},{"internalType":"bytes32","name":"asset","type":"bytes32"},{"internalType":"bytes32","name":"key","type":"bytes32"},{"internalType":"uint256","name":"maxLeverage","type":"uint256"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"uint256","name":"marketSize","type":"uint256"},{"internalType":"int256","name":"marketSkew","type":"int256"},{"internalType":"uint256","name":"marketDebt","type":"uint256"},{"internalType":"int256","name":"currentFundingRate","type":"int256"},{"internalType":"int256","name":"currentFundingVelocity","type":"int256"},{"components":[{"internalType":"uint256","name":"takerFee","type":"uint256"},{"internalType":"uint256","name":"makerFee","type":"uint256"},{"internalType":"uint256","name":"takerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"takerFeeOffchainDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeOffchainDelayedOrder","type":"uint256"}],"internalType":"struct PerpsV2MarketData.FeeRates","name":"feeRates","type":"tuple"}],"internalType":"struct PerpsV2MarketData.MarketSummary[]","name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32[]","name":"marketKeys","type":"bytes32[]"}],"name":"marketSummariesForKeys","outputs":[{"components":[{"internalType":"address","name":"market","type":"address"},{"internalType":"bytes32","name":"asset","type":"bytes32"},{"internalType":"bytes32","name":"key","type":"bytes32"},{"internalType":"uint256","name":"maxLeverage","type":"uint256"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"uint256","name":"marketSize","type":"uint256"},{"internalType":"int256","name":"marketSkew","type":"int256"},{"internalType":"uint256","name":"marketDebt","type":"uint256"},{"internalType":"int256","name":"currentFundingRate","type":"int256"},{"internalType":"int256","name":"currentFundingVelocity","type":"int256"},{"components":[{"internalType":"uint256","name":"takerFee","type":"uint256"},{"internalType":"uint256","name":"makerFee","type":"uint256"},{"internalType":"uint256","name":"takerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"takerFeeOffchainDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeOffchainDelayedOrder","type":"uint256"}],"internalType":"struct PerpsV2MarketData.FeeRates","name":"feeRates","type":"tuple"}],"internalType":"struct PerpsV2MarketData.MarketSummary[]","name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"marketKey","type":"bytes32"}],"name":"parameters","outputs":[{"components":[{"internalType":"uint256","name":"takerFee","type":"uint256"},{"internalType":"uint256","name":"makerFee","type":"uint256"},{"internalType":"uint256","name":"takerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"takerFeeOffchainDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeOffchainDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"maxLeverage","type":"uint256"},{"internalType":"uint256","name":"maxMarketValue","type":"uint256"},{"internalType":"uint256","name":"maxFundingVelocity","type":"uint256"},{"internalType":"uint256","name":"skewScale","type":"uint256"},{"internalType":"uint256","name":"nextPriceConfirmWindow","type":"uint256"},{"internalType":"uint256","name":"delayedOrderConfirmWindow","type":"uint256"},{"internalType":"uint256","name":"minDelayTimeDelta","type":"uint256"},{"internalType":"uint256","name":"maxDelayTimeDelta","type":"uint256"},{"internalType":"uint256","name":"offchainDelayedOrderMinAge","type":"uint256"},{"internalType":"uint256","name":"offchainDelayedOrderMaxAge","type":"uint256"},{"internalType":"bytes32","name":"offchainMarketKey","type":"bytes32"},{"internalType":"uint256","name":"offchainPriceDivergence","type":"uint256"},{"internalType":"uint256","name":"liquidationPremiumMultiplier","type":"uint256"},{"internalType":"uint256","name":"liquidationBufferRatio","type":"uint256"},{"internalType":"uint256","name":"maxLiquidationDelta","type":"uint256"},{"internalType":"uint256","name":"maxPD","type":"uint256"}],"internalType":"struct IPerpsV2MarketSettings.Parameters","name":"","type":"tuple"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"contract IPerpsV2MarketViews","name":"market","type":"address"},{"internalType":"address","name":"account","type":"address"}],"name":"positionDetails","outputs":[{"components":[{"components":[{"internalType":"uint64","name":"id","type":"uint64"},{"internalType":"uint64","name":"lastFundingIndex","type":"uint64"},{"internalType":"uint128","name":"margin","type":"uint128"},{"internalType":"uint128","name":"lastPrice","type":"uint128"},{"internalType":"int128","name":"size","type":"int128"}],"internalType":"struct IPerpsV2MarketBaseTypes.Position","name":"position","type":"tuple"},{"internalType":"int256","name":"notionalValue","type":"int256"},{"internalType":"int256","name":"profitLoss","type":"int256"},{"internalType":"int256","name":"accruedFunding","type":"int256"},{"internalType":"uint256","name":"remainingMargin","type":"uint256"},{"internalType":"uint256","name":"accessibleMargin","type":"uint256"},{"internalType":"uint256","name":"liquidationPrice","type":"uint256"},{"internalType":"bool","name":"canLiquidatePosition","type":"bool"}],"internalType":"struct PerpsV2MarketData.PositionData","name":"","type":"tuple"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"marketKey","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"positionDetailsForMarketKey","outputs":[{"components":[{"components":[{"internalType":"uint64","name":"id","type":"uint64"},{"internalType":"uint64","name":"lastFundingIndex","type":"uint64"},{"internalType":"uint128","name":"margin","type":"uint128"},{"internalType":"uint128","name":"lastPrice","type":"uint128"},{"internalType":"int128","name":"size","type":"int128"}],"internalType":"struct IPerpsV2MarketBaseTypes.Position","name":"position","type":"tuple"},{"internalType":"int256","name":"notionalValue","type":"int256"},{"internalType":"int256","name":"profitLoss","type":"int256"},{"internalType":"int256","name":"accruedFunding","type":"int256"},{"internalType":"uint256","name":"remainingMargin","type":"uint256"},{"internalType":"uint256","name":"accessibleMargin","type":"uint256"},{"internalType":"uint256","name":"liquidationPrice","type":"uint256"},{"internalType":"bool","name":"canLiquidatePosition","type":"bool"}],"internalType":"struct PerpsV2MarketData.PositionData","name":"","type":"tuple"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"resolverProxy","outputs":[{"internalType":"contract IAddressResolver","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"}]'
market_data_contract = w3.eth.contract(address=market_data_adddress, abi=market_data_abi)

perps_settings_address = '0x649F44CAC3276557D03223Dbf6395Af65b11c11c'
perps_settings_abi = '[{"inputs":[{"internalType":"address","name":"_owner","type":"address"},{"internalType":"address","name":"_resolver","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"name","type":"bytes32"},{"indexed":false,"internalType":"address","name":"destination","type":"address"}],"name":"CacheUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"keeperFee","type":"uint256"}],"name":"KeeperLiquidationFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"bps","type":"uint256"}],"name":"LiquidationBufferRatioUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"bps","type":"uint256"}],"name":"LiquidationFeeRatioUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"sUSD","type":"uint256"}],"name":"MaxKeeperFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"minMargin","type":"uint256"}],"name":"MinInitialMarginUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"sUSD","type":"uint256"}],"name":"MinKeeperFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"oldOwner","type":"address"},{"indexed":false,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnerChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnerNominated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"marketKey","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"parameter","type":"bytes32"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"ParameterUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"marketKey","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"parameter","type":"bytes32"},{"indexed":false,"internalType":"bytes32","name":"value","type":"bytes32"}],"name":"ParameterUpdatedBytes32","type":"event"},{"constant":true,"inputs":[],"name":"CONTRACT_NAME","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"acceptOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"delayedOrderConfirmWindow","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"isResolverCached","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"keeperLiquidationFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"liquidationBufferRatio","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"liquidationFeeRatio","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"liquidationPremiumMultiplier","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"makerFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"makerFeeDelayedOrder","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"makerFeeOffchainDelayedOrder","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"maxDelayTimeDelta","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"maxFundingVelocity","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"maxKeeperFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"maxLeverage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"maxLiquidationDelta","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"maxMarketValue","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"maxPD","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"minDelayTimeDelta","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"minInitialMargin","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"minKeeperFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"nextPriceConfirmWindow","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"nominateNewOwner","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"nominatedOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"offchainDelayedOrderMaxAge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"offchainDelayedOrderMinAge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"offchainMarketKey","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"offchainPriceDivergence","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"parameters","outputs":[{"components":[{"internalType":"uint256","name":"takerFee","type":"uint256"},{"internalType":"uint256","name":"makerFee","type":"uint256"},{"internalType":"uint256","name":"takerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"takerFeeOffchainDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeOffchainDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"maxLeverage","type":"uint256"},{"internalType":"uint256","name":"maxMarketValue","type":"uint256"},{"internalType":"uint256","name":"maxFundingVelocity","type":"uint256"},{"internalType":"uint256","name":"skewScale","type":"uint256"},{"internalType":"uint256","name":"nextPriceConfirmWindow","type":"uint256"},{"internalType":"uint256","name":"delayedOrderConfirmWindow","type":"uint256"},{"internalType":"uint256","name":"minDelayTimeDelta","type":"uint256"},{"internalType":"uint256","name":"maxDelayTimeDelta","type":"uint256"},{"internalType":"uint256","name":"offchainDelayedOrderMinAge","type":"uint256"},{"internalType":"uint256","name":"offchainDelayedOrderMaxAge","type":"uint256"},{"internalType":"bytes32","name":"offchainMarketKey","type":"bytes32"},{"internalType":"uint256","name":"offchainPriceDivergence","type":"uint256"},{"internalType":"uint256","name":"liquidationPremiumMultiplier","type":"uint256"},{"internalType":"uint256","name":"liquidationBufferRatio","type":"uint256"},{"internalType":"uint256","name":"maxLiquidationDelta","type":"uint256"},{"internalType":"uint256","name":"maxPD","type":"uint256"}],"internalType":"struct IPerpsV2MarketSettings.Parameters","name":"","type":"tuple"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"rebuildCache","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"resolver","outputs":[{"internalType":"contract AddressResolver","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"resolverAddressesRequired","outputs":[{"internalType":"bytes32[]","name":"addresses","type":"bytes32[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_delayedOrderConfirmWindow","type":"uint256"}],"name":"setDelayedOrderConfirmWindow","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"_keeperFee","type":"uint256"}],"name":"setKeeperLiquidationFee","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_ratio","type":"uint256"}],"name":"setLiquidationBufferRatio","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"_ratio","type":"uint256"}],"name":"setLiquidationFeeRatio","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_liquidationPremiumMultiplier","type":"uint256"}],"name":"setLiquidationPremiumMultiplier","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_makerFee","type":"uint256"}],"name":"setMakerFee","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_makerFeeDelayedOrder","type":"uint256"}],"name":"setMakerFeeDelayedOrder","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_makerFeeOffchainDelayedOrder","type":"uint256"}],"name":"setMakerFeeOffchainDelayedOrder","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_maxDelayTimeDelta","type":"uint256"}],"name":"setMaxDelayTimeDelta","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_maxFundingVelocity","type":"uint256"}],"name":"setMaxFundingVelocity","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"_sUSD","type":"uint256"}],"name":"setMaxKeeperFee","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_maxLeverage","type":"uint256"}],"name":"setMaxLeverage","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_maxLiquidationDelta","type":"uint256"}],"name":"setMaxLiquidationDelta","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_maxMarketValue","type":"uint256"}],"name":"setMaxMarketValue","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_maxPD","type":"uint256"}],"name":"setMaxPD","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_minDelayTimeDelta","type":"uint256"}],"name":"setMinDelayTimeDelta","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"_minMargin","type":"uint256"}],"name":"setMinInitialMargin","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"_sUSD","type":"uint256"}],"name":"setMinKeeperFee","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_nextPriceConfirmWindow","type":"uint256"}],"name":"setNextPriceConfirmWindow","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_offchainDelayedOrderMaxAge","type":"uint256"}],"name":"setOffchainDelayedOrderMaxAge","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_offchainDelayedOrderMinAge","type":"uint256"}],"name":"setOffchainDelayedOrderMinAge","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"bytes32","name":"_offchainMarketKey","type":"bytes32"}],"name":"setOffchainMarketKey","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_offchainPriceDivergence","type":"uint256"}],"name":"setOffchainPriceDivergence","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"components":[{"internalType":"uint256","name":"takerFee","type":"uint256"},{"internalType":"uint256","name":"makerFee","type":"uint256"},{"internalType":"uint256","name":"takerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"takerFeeOffchainDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"makerFeeOffchainDelayedOrder","type":"uint256"},{"internalType":"uint256","name":"maxLeverage","type":"uint256"},{"internalType":"uint256","name":"maxMarketValue","type":"uint256"},{"internalType":"uint256","name":"maxFundingVelocity","type":"uint256"},{"internalType":"uint256","name":"skewScale","type":"uint256"},{"internalType":"uint256","name":"nextPriceConfirmWindow","type":"uint256"},{"internalType":"uint256","name":"delayedOrderConfirmWindow","type":"uint256"},{"internalType":"uint256","name":"minDelayTimeDelta","type":"uint256"},{"internalType":"uint256","name":"maxDelayTimeDelta","type":"uint256"},{"internalType":"uint256","name":"offchainDelayedOrderMinAge","type":"uint256"},{"internalType":"uint256","name":"offchainDelayedOrderMaxAge","type":"uint256"},{"internalType":"bytes32","name":"offchainMarketKey","type":"bytes32"},{"internalType":"uint256","name":"offchainPriceDivergence","type":"uint256"},{"internalType":"uint256","name":"liquidationPremiumMultiplier","type":"uint256"},{"internalType":"uint256","name":"liquidationBufferRatio","type":"uint256"},{"internalType":"uint256","name":"maxLiquidationDelta","type":"uint256"},{"internalType":"uint256","name":"maxPD","type":"uint256"}],"internalType":"struct IPerpsV2MarketSettings.Parameters","name":"_parameters","type":"tuple"}],"name":"setParameters","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_skewScale","type":"uint256"}],"name":"setSkewScale","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_takerFee","type":"uint256"}],"name":"setTakerFee","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_takerFeeDelayedOrder","type":"uint256"}],"name":"setTakerFeeDelayedOrder","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"},{"internalType":"uint256","name":"_takerFeeOffchainDelayedOrder","type":"uint256"}],"name":"setTakerFeeOffchainDelayedOrder","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"skewScale","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"takerFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"takerFeeDelayedOrder","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"_marketKey","type":"bytes32"}],"name":"takerFeeOffchainDelayedOrder","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}]'
perps_settings_contract = w3.eth.contract(address=perps_settings_address, abi=perps_settings_abi)

def get_exact_liquidation_price(liquidatedAccount):
    marketKey = Web3.to_bytes(text='sETHPERP').ljust(32, b'\0')
    position_details = market_data_contract.functions.positionDetailsForMarketKey(marketKey, liquidatedAccount).call(block_identifier=96833946)
    (position, _, _, accruedFundingInUsd, _, _, estimatedLiquidationPrice, _) = position_details
    (_, _, margin, fillPrice, positionSize) = position
    print('estimatedLiquidationPrice', estimatedLiquidationPrice / 1e18)
    df = pd.DataFrame(data=np.array(list(range(-500, 501, 1))), columns=['prices'])
    df["prices"] = (1 + df["prices"] / 1e4) * estimatedLiquidationPrice / 1e18
    minKeeperFee = perps_settings_contract.functions.minKeeperFee().call() / 1e18
    maxKeeperFee = perps_settings_contract.functions.maxKeeperFee().call() / 1e18
    liquidationBufferRatioInBp = perps_settings_contract.functions.liquidationBufferRatio(marketKey).call() / 1e18 * 1e4  # liquidator reward
    liquidationFeeRatioInBp = perps_settings_contract.functions.liquidationFeeRatio().call() / 1e18 * 1e4  # stakers rewards
    skewScale = perps_settings_contract.functions.skewScale(marketKey).call() / 1e18
    liquidationPremiumMultiplier = perps_settings_contract.functions.liquidationPremiumMultiplier(marketKey).call() / 1e18
    # print(df["prices"])

    # start with initial margin
    df["remaining_margin"] = margin / 1e18
    # add/remove funding
    df["remaining_margin"] = df["remaining_margin"] + accruedFundingInUsd / 1e18
    # add/remove profit/loss
    df["remaining_margin"] = df["remaining_margin"] + (df["prices"] - fillPrice / 1e18) * positionSize / 1e18
    # remove liquidation premium
    df["remaining_margin"] = df["remaining_margin"] - positionSize ** 2 / 1e18 / skewScale / 1e18 * df[
        "prices"] * liquidationPremiumMultiplier
    # remove keeper fees min then max
    df["keeper_fee"] = df["prices"].apply(
        lambda p: max(p * abs(positionSize) / 1e18 * liquidationFeeRatioInBp / 1e4, minKeeperFee))
    df["keeper_fee"] = df["keeper_fee"].apply(lambda x: min(x, maxKeeperFee))
    # remove stakers fees
    df["stakers_fee"] = df["prices"] * abs(positionSize) / 1e18 * liquidationBufferRatioInBp / 1e4
    # net out against remaining margin
    df["remaining_margin"] = df["remaining_margin"] - df["keeper_fee"] - df["stakers_fee"]
    # liquidation price is the first price where remaining margin turns negative

    # if all(df["remaining_margin"]<0) or all(df["remaining_margin"]>0):
    #     return estimatedLiquidationPrice    
    
    if positionSize > 0:
        return df["prices"][df["remaining_margin"] < 0].max()
    else:
        return df["prices"][df["remaining_margin"] < 0].min()


address = '0x7e7f1b10a3061e8ab8c8449ddcc5f95650d9637e'
clean_address = Web3.to_checksum_address(address)

print('exactLiquidationPrice', get_exact_liquidation_price(clean_address))
